# repository_mesh.py, 22/11/05 22:45
# about 4M elements at time about 4 minutes
# Seems to be on the edge of what is tracktable while providing full resolution of EDZ without anisotropic mesh.

# base of the mesh file name

simulation:
    cfg:  "config_sim.yaml"
    mesh: "simulation_mesh.vtu" 
    hdf:  "sampled_fixed.h5"

pbs:
    # for proecess_boreholes.py
    n_workers: 40
    queue: charon

local:
    n_workers: 4

mesh_name: random_fractures

mesh:
    # mesh step on fractures
    fracture_mesh_step: 10
    # mesh step on outer boundary
    boundary_mesh_step: 50
    # mesh step on outer boundary of EDZ (just around boreholes right now)
    edz_mesh_step: 1
    # mesh step on inner boreholes
    boreholes_mesh_step: 0.3   # haxagon boreholes
    #boreholes_mesh_step: 0.3   # EDZ minimal resolution
    main_tunnel_mesh_step: 2

    # refinement around central lines of the laterals
    line_refinement:
      r_inner: 2
      h_inner: 1.5
      r_outer: 5
      h_outer: 1.5
      q_outer: 1
      r_inf: 30
      h_inf: 10

geometry:
  # Coordinate system
  # X - in direction of storage boreholes
  # Y - perpendicular horizontal
  # Z - vertical
  # origin: floor of the lateral tunnel, center, interface with center borehole.


  # depth of the center of the box and of the coordinate system
  center_depth: 5000
  # x,y,z dimension
  box_dimensions: [70, 60, 60]
  # mesh step on fractures
  fracture_mesh_step: 10
  # upper limit on the number of fractures
  n_frac_limit: 3
  # mesh step on outer boundary
  boundary_mesh_step: 30
  # mesh step on outer boundary of EDZ (just around boreholes right now)
  edz_mesh_step: 0.4
  # mesh step on inner boreholes
  boreholes_mesh_step: 0.6   # haxagon boreholes
  #boreholes_mesh_step: 0.3   # EDZ minimal resolution
  main_tunnel_mesh_step: 3
  # Radious of outer boundary of EDZ (just for mesh step field)
  edz_radius: 3
  # Center distance of laterlas
  laterals_distance: 10

  # Main tunnel - main access tunnel
  main_tunnel:
      vertical_side: 2.800
      # radius of the ceiling/roof
      #radius: 3.5
      # height of side walls (tunnel height minus roof)
      height: 4
      # tunnel width
      width: 4
      # tunnel length
      length: 80

  # Lateral short tunnels perpendicular to the main tunnel
  # one ofr every storage borehole
  lateral_tunnel:
      vertical_side: 2.800
      #radius: 3.5
      height: 4
      width: 4
      length: 10

  # Storage boreholes
  borehole:
      # Total number of side boreoholes (one side) resolved and homogenized.
      n_sides: 0
      # Number of explicit side boreholes (addition to the central source borehole)
      n_explicit: 0
      # Boreholes radius
      radius: 1.1
      # Boreholes length
      length: 300
      # Vertical position of the borehole center.
      z_pos: 1.1
      # horizontal gaps between boreholes; (2 * n_side_boreholes) * borehole_distance should be < main_tunnel.length
      # not checked in the code
      y_spacing: 25

boreholes:
    common: &COMMON
        origin_stationing: 37
        galery_width: 4.0
        l5_azimuth: 110

        # orientation of foliation plane and accepted deviation of boreholes
        foliation_latitude: 45
        foliation_longitude: 265
        #foliation_angle_tolerance: 80
        foliation_angle_tolerance: 90

        point_step: 0.5             # absolute step of evaluation points (in meters)
        n_points_per_bh: 70      # borehole at most 20m active section
        n_boreholes_to_select: 6
        plot_chamber_size: 4      # chamber size in points used for chamber sensitivity plots
        time_plot_points_step: 4    # Make the time plot of a stat. function for every STEP point.
        max_bh_length: 30
      
    zk_40:  &ZK_40          # zk5_1S
        invert_xy: True
        common: *COMMON
        transform_shift: [0, 5, 1.8]

        avoid_cylinder: [3, 0, 12]        # r, x0, x1
        active_cylinder: [20, 2, 30]      # r, x0, x1

        lines_dict:
            right_far_up: # 26, 1.7
                start_x: 0.4
                start_y: -9 #, -10, -11]
                start_z: -0.3
                end_x: 11 #, 12] #, 13, 14]
                end_y: 0
                end_z: 3.4 #, 3.6] #, 4.0 ]

            right_near_dn: # 26, 1.7
                start_x: 0.4
                start_y: -11 #, -12, -14] #, -15, -16]
                start_z: 0.3
                end_x: 5
                end_y: 0
                end_z: -3.4 #, -3.4, -3.6]

            mid_far_up: # 26, 1.7
                start_x: 0.4
                start_y: [5.5, 6, 6.5]
                start_z: 0.1
                end_x: [11, 13, 15, 17, 19]
                end_y: 0
                end_z: [ 3.1, 3.3, 3.5, 3.7, 3.9 ]

            mid_far_dn: # 26, 1.7
                start_x: 0.4
                start_y: [5.5, 6, 6.5]
                start_z: 0.1
                end_x: [ 11, 13, 15 , 17, 19]
                end_y: 0
                end_z: [-2.9, -3.1, -3.3, -3.5, -3.7 ]

        # degree, if starts from 0, completed symmetricaly to negative angles
        # small case, about 157 boreholes
        #y_angles: [0, 20, 40, 60, 80]
        #z_angles: [0, 10, 20, 40]
        #z_angles: [0, 3, 5, 7, 9, 11, 15, 25]

        # large case, about 431 active boreholes
        #y_angles: [0, 10, 20, 30, 40, 50, 60, 80]
        #z_angles: [0, 5, 10, 15, 25, 45, 70]

        #wh_pos_step: [3, 5, 1]
        #wh_zones:
            #   Each zone is a box given by min and max corners
            #- [[-1, -5, -0.4],  [+1, -20, 0.1]]  # min, max
            #- [[-1, 15, -0.4],  [+1, 25, 0.1]]    # min, max

    zk_30: &ZK_30            # zk5_1S
        invert_xy: False
        common: *COMMON
        transform_shift: [0, -5, 1.8]

        avoid_cylinder: [3, 0, 12]        # r, x0, x1
        active_cylinder: [20, 2, 30]      # r, x0, x1

        lines_dict:
            # left long variants
            left_up:    # wall about: 48, 2.5m
                start_x: 0.4
                start_y: 18
                start_z: 0.1
                end_x: [ 10, 12, 14 ]
                end_y: 0
                end_z: [ 3.2, 3.7, 4.4, 5.2, 6 ]
            left_dn:  #  48 , 1.5
                start_x: 0.4
                start_y: 18
                start_z: 0.1
                end_x: [ 10, 12, 14 ]
                end_y: 0
                end_z: [ -6, -5.2, -4.5, -3.8, -3.3 ]
            left_mid_dn:  # 48, 1.1
                start_x: 0.4
                start_y: 20
                # ??? 18 neprojde, 19 jen neco
                start_z: 0.1
                end_x: [ 7, 8, 9 ]
                end_y: 0
                end_z: [ -6, -5.2, -4.5, -3.8, -3.3 ]

            mid_far_up:
                start_x: 0.4
                start_y: 5.5
                start_z: 0.1
                end_x: [ 10, 12, 14 ]
                end_y: 0
                end_z: [ 3.2, 3.7, 4.4, 5.2, 6 ]
            mid_far_dn:
                start_x: 0.4
                start_y: 5.5
                start_z: 0.1
                end_x: [ 10, 12, 14 ]
                end_y: 0
                end_z: [ -6, -5.2, -4.5, -3.8, -3.3 ]
            mid_mid_dn:
                start_x: 0.4
                start_y: 6
                start_z: 0.1
                end_x: [ 7, 8, 9 ]
                end_y: 0
                end_z: [ -6, -5.2, -4.5, -3.8, -3.3 ]

#            # middle variants, [ 5, 1.5]
            middle:
                start_x: 0.4
                start_y: 5
                start_z: 0.1
                end_x: 13
                end_y: [ 5, 4.2, 3.5, 3 ]
                end_z: [ -1.5, 0, 1.5 ]
            # Vetšina v kolizi s foliací (Commented out section)
            # keep for optimization, but probably reject later, rather use left_far_up
            # shifted start allows to pass at least some of them
            right_far_up: # [26, 2.7]
                start_x: 0.4
                start_y: [ -7, -9 ]
                start_z: 0.1
                end_x: [ 10, 12, 14 ]
                end_y: 0
                end_z: [ 3.2, 3.7, 4.4, 5.2, 6 ]
            right_far_dn: # [21, 1]
                start_x: 0.4
                start_y: [-11, -13]
                start_z: 0.1
                end_x: [10, 12, 14]
                end_y: 0
                end_z: [-6, -5.2, -4.5, -3.8, -3.3]

            right_mid_up:   #[ 22, 3]
                start_x: 0.4
                start_y:  -13
                start_z: 0.1
                end_x: [ 6, 7, 8, 9 ]
                end_y: 0
                end_z: [ 3.2, 3.7, 4.4, 5.2, 6 ]
            right_mid_dn:   #[ 22, 1]
                start_x: 0.4
                start_y: -13
                start_z: 0.1
                end_x: [ 6, 7, 8, 9 ]
                end_y: 0
                end_z: [ -6, -5.2, -4.5, -3.8, -3.3 ]

            right_near_up:  #[23, 3-5m !!
                start_x: 0.4
                start_y: -13
                start_z: 0.1
                end_x: [ 3, 4, 5 ]
                end_y: 0
                end_z: [ 3.3, 3.7, 4.4 ]
            right_near_dn: #[23  - 27, -0.4 az 0.9
                start_x: 0.4
                start_y: -13
                start_z: 0.5
                end_x: [ 3, 4, 5 ]
                end_y: 0
                end_z: [ -4.5, -3.8, -3.3 ]
            right_middle: # 26, 1.7
                start_x: 0.4
                start_y: [ -5, -6 ]
                start_z: 0.1
                end_x: 13
                end_y: [ -3, -3.5, -4.2 , -5, -6 ]
                end_z: [ -1.5, 0, 1.5 ]


        subset:
            # mid_far_up:  OK
            - P +5-25+15
            - P +5-22+16
            - P +5-22+13
            # mid_far_dn    OK
            - P +5-22-14
            - P +5-22-17
            - P +5-25-16
            # right_far_dn OK
            - P-13+53-11
            - P-11+43-12
            - P-11+48-13
            - P-13+48-11
            # mid_mid_dn    OK
            - P +6-34-20
            - P +6-38-21
            - P +6-38-25
            # right_mid_dn OK
            - P-13+56-12
            - P-13+59-12
            - P-13+66-13
            # right_mid_up: OK
            - P-13+56+11
            - P-13+66+12
            - P-13+63+12
            - P-13+59+11
            #right_near_up:   OK
            - P-13+74+13
            - P-13+70+13
            # right_near_dn: OK
            - P-13+70-15
            - P-13+74-15
            # right_middle  OK
            - P -6+13+06
            - P -5+00-07
            - P -6+13-07
            - P -6+13+00
            - P -6+11-07
            - P -6+11+00
            - P -6+08-07
            - P -6+04-07
            # middle
            - P +5-09+00
            - P +5-09-07

      # degree, if starts from 0, completed symmetricaly to negative angles
      # small case, about 157 boreholes
      #y_angles: [0, 20, 40, 60, 80]
      #z_angles: [0, 10, 20, 40]
      #z_angles: [0, 3, 5, 7, 9, 11, 15, 25]

      # large case, about 431 active boreholes
      #y_angles: [0, 10, 20, 30, 40, 50, 60, 80]
      #z_angles: [0, 5, 10, 15, 25, 45, 70]

      #wh_pos_step: [3, 5, 1]
      #wh_zones:
        #   Each zone is a box given by min and max corners
        # - [[-1, -5, -0.4],  [+1, -20, 0.1]]  # min, max
        # - [[-1, 15, -0.4],  [+1, 25, 0.1]]    # min, max
        #max_bh_length: 30
      #force: True      # Force BHSet  data sampling update, use for changing BHSet config, mesh or HDF5
    force: False
    #active_zk: *ZK_30
    active_zk: *ZK_40
    
chambers: # Parameters of Chamber sensitivity precalculation
    packer_size: 2          # Size of packer in terms of points
    min_chamber_size: 2     # Size in terms of points
    noise: 5.0 # [m] = [0.01 MPa]

chambers_optimize:
    todo: False

optimize:
    # Borehole sampling points
    #borohole_length_rel: 2

    # Optimization space
    n_packers: 4            # meaning 3 chambers
    n_best_packer_conf: 5   # How many best configurations preselect: per borehole  and per parameter
    weights: [1.0, 0.1]     # weights of Linf and L1 norm; Linf = np.max(values), L1 = np.mean(np.abs(values))
                            # See e.g. src/endorse/Bukov2/bh_chambers.py: packers_eval()

    # Algorithm params
    population_size: 3
    n_generations: 1
    crossover_probability: 0.8
    mutation_probability: 0.2

    # evaluation params
    n_workers: 4
    #workers_per_node: 4     # for PBS only

fracture_stats:
    # SKB data
    -   name: NS
        trend: 292
        plunge: 1
        concentration: 17.8
        power: 2.5
#          r_min: 0.038
        r_min: 1
        r_max: 564
        p_32: 0.094
    -   name: NE
        trend: 326
        plunge: 2
        concentration: 14.3
        power: 2.7
        r_min: 1
        r_max: 564
        p_32: 0.163
    -   name: NW
        trend: 60
        plunge: 6
        concentration: 12.9
        power: 3.1
        r_min: 1
        r_max: 564
        p_32: 0.098
    -   name: EW
        trend: 15
        plunge: 2
        concentration: 14.0
        power: 3.1
        r_min: 1
        r_max: 564
        p_32: 0.039
    -   name: HZ
        trend: 5
        plunge: 86
        concentration: 15.2
        power: 2.38
        r_min: 1
        r_max: 564
        p_32: 0.141

